<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SignalR Chat Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f5f5f5;
    }
    h2 { color: #333; }
    #messages {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
      background: #fff;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      margin-right: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

<h2>ğŸ”Œ SignalR Chat Test</h2>
<div id="messages"></div>

<input type="text" id="receiverId" placeholder="Receiver ID" />
<input type="text" id="messageInput" placeholder="Enter your message" />
<button onclick="sendMessage()">Send</button>

<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
<script>
  const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJRCI6IjE4Zjg0NTFiLWQ2NjYtNDViMi1iNzRmLWU5MGI2YzU5YTAyNyIsIkVtYWlsIjoieWFiYmdoYWdoQGdtYWlsLmNvbSIsImZ1bGxOYW1lIjoiYWJkdWxsYWgiLCJwaG9uZU51bWJlciI6IisxNTUxNDQzNyIsImp0aSI6IjI5YWVjN2I1LWEyMGYtNDQxMC05MmU0LTZjYzQ3YTk2OThlYiIsIlJvbGUiOiJBZG1pbiIsImV4cCI6MTc1Njc0MDkwNiwiaXNzIjoiaHR0cHM6Ly9maXJzdHByb2plY3QudGFraGxlZXNhay5jb20iLCJhdWQiOiJodHRwczovL2ZpcnN0cHJvamVjdC50YWtobGVlc2FrLmNvbSJ9.24FKC4po10DQBsr2eOijkf3bTFMWT63xNy5dyWrN3z0";

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Hub
  const connection = new signalR.HubConnectionBuilder()
    .withUrl("https://customerservice.runasp.net/chatHub", {
      transport: signalR.HttpTransportType.WebSockets,
      accessTokenFactory: () => token // ğŸ”‘ ØªÙˆÙƒÙ† ÙÙŠ Header
    })
    .configureLogging(signalR.LogLevel.Information)
    .withAutomaticReconnect()
    .build();

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  connection.on("ReceiveMessage", (message) => {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML += `<div>ğŸ“© ${message}</div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Errors / Info
  connection.on("Error", (msg) => alert(`âŒ Error: ${msg}`));
  connection.on("Info", (msg) => console.log(`â„¹ï¸ Info: ${msg}`));

  // Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
  async function startConnection() {
    try {
      await connection.start();
      console.log("âœ… Connected to SignalR hub");
    } catch (err) {
      console.error("âŒ Error connecting:", err);
      setTimeout(startConnection, 5000); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
    }
  }
  startConnection();

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  function sendMessage() {
    const receiverId = document.getElementById("receiverId").value.trim();
    const message = document.getElementById("messageInput").value.trim();

    if (!receiverId || !message) {
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„!");
      return;
    }

    console.log(`Sending message to ${receiverId}: ${message}`);
    connection.invoke("SendMessageToUser", receiverId, message)
      .then(() => {
        console.log("âœ… Message sent");
        document.getElementById("messageInput").value = "";
      })
      .catch(err => console.error("âŒ Error sending message:", err));
  }
</script>

</body>
</html>
